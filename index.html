<!DOCTYPE html>
<html>
<head>
    <title>Interactive Drawing with Sensors</title>
    <style>
        #canvas {
            border: 1px solid black;
            width: 100%;
            height: 400px;
        }
        #permissionButton {
            display: none; /* Inicialmente oculto, mostrado apenas quando necess√°rio */
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <button id="permissionButton">Enable Motion and Orientation</button>
    <p>Rotate your device to draw. The magnetic direction and ambient light will affect the drawing color.</p>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const permissionButton = document.getElementById('permissionButton');
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;

        let hue = 0;
        let lightLevel = 100; // Default light level

        // Map range function
        function mapRange(value, a, b, c, d) {
            value = (value - a) / (b - a);
            return c + value * (d - c);
        }

        // Draw function
        function draw(x, y, color) {
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(x, y, 10, 0, 2 * Math.PI);
            ctx.fill();
        }

        // Check for iOS 13+ and request permission for sensor access
        if (typeof DeviceMotionEvent.requestPermission === 'function') {
            permissionButton.style.display = 'block';
            permissionButton.addEventListener('click', () => {
                DeviceMotionEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            startSensorEvents();
                        }
                        permissionButton.style.display = 'none';
                    })
                    .catch(console.error);
            });
        } else {
            // For non-iOS 13+ devices
            startSensorEvents();
        }

        function startSensorEvents() {
            // Handle device orientation
            window.addEventListener('deviceorientation', event => {
                const { alpha, beta, gamma } = event;
                const x = mapRange(gamma, -90, 90, 0, canvas.width);
                const y = mapRange(beta, -90, 90, 0, canvas.height);
                draw(x, y, `hsl(${hue}, 100%, ${lightLevel}%)`);
            });

            // Update color based on magnetic orientation
            window.addEventListener('compassneedscalibration', event => {
                event.preventDefault();
                hue = (hue + 5) % 360;
            });

            // Ambient light sensor (works only in some browsers)
            if ('AmbientLightSensor' in window) {
                try {
                    const sensor = new AmbientLightSensor();
                    sensor.addEventListener('reading', () => {
                        lightLevel = sensor.illuminance;
                    });
                    sensor.start();
                } catch (e) {
                    console.log('AmbientLightSensor not supported');
                }
            }
        }
    </script>
</body>
</html>
