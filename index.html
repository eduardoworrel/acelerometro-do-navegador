<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Velocidade do Acelerômetro</title>
</head>
<body>
    <br>
    <h1 id="velocity">0 m/s</h1>
    <br>
    <button id="calibrateButton">Calibrar Acelerômetro</button>
    <button id="startButton">Iniciar Captura de Movimento</button>

    <script>
        let velocity = 0;
        let lastTime = Date.now();
        let calibratedGravity = { x: 0, y: 0, z: 0 };
        let isCalibrated = false;
        const tolerance = 0.05; // Tolerância para movimento significativo

        function calibrateAcceleration(event) {
            calibratedGravity.x = event.accelerationIncludingGravity.x / 9.8;
            calibratedGravity.y = event.accelerationIncludingGravity.y / 9.8;
            calibratedGravity.z = event.accelerationIncludingGravity.z / 9.8;
            isCalibrated = true;
            alert("Acelerômetro calibrado!");
            window.removeEventListener('devicemotion', calibrateAcceleration);
        }

        function handleMotion(event) {
            if (!isCalibrated) return;

            let currentTime = Date.now();
            let deltaTime = (currentTime - lastTime) / 1000; // Tempo em segundos
            lastTime = currentTime;

            let ax = (event.accelerationIncludingGravity.x / 9.8) - calibratedGravity.x;
            let ay = (event.accelerationIncludingGravity.y / 9.8) - calibratedGravity.y;
            let az = (event.accelerationIncludingGravity.z / 9.8) - calibratedGravity.z;

            let accelerationMagnitude = Math.sqrt(ax * ax + ay * ay + az * az);

            if (accelerationMagnitude < tolerance) {
                velocity = 0;
            } else {
                velocity += accelerationMagnitude * deltaTime;
            }

            document.getElementById('velocity').textContent = `${velocity.toFixed(2)} m/s`;
        }

        document.getElementById('calibrateButton').addEventListener('click', function() {
            window.addEventListener('devicemotion', calibrateAcceleration);
        });

        document.getElementById('startButton').addEventListener('click', function() {
            if (!isCalibrated) {
                alert("Por favor, calibre o acelerômetro primeiro.");
                return;
            }

            if (typeof DeviceMotionEvent.requestPermission === 'function') {
                // Para iOS 13+
                DeviceMotionEvent.requestPermission()
                .then(permissionState => {
                    if (permissionState === 'granted') {
                        window.addEventListener('devicemotion', handleMotion);
                    } else {
                        alert('Permissão para acessar o acelerômetro negada.');
                    }
                })
                .catch(console.error);
            } else {
                // Para outros navegadores
                window.addEventListener('devicemotion', handleMotion);
            }
        });
    </script>
</body>
</html>
